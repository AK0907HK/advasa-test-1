<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>ログイン</h1>
  <form id="login-form">
    <label>
      ユーザー名
      <input name="username" required />
    </label>
    <br />
    <label>
      パスワード
      <input name="password" type="password" required />
    </label>
    <br />
    <button type="submit">サインイン</button>
  </form>

  <p id="error" style="color:crimson;"></p>

  <script>
    const form = document.getElementById("login-form");
    const errorBox = document.getElementById("error");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorBox.textContent = "";

      const data = {
        username: form.username.value,
        password: form.password.value,
      };

      try {
        const res = await fetch("/api/auth/token/", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(data),
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({detail:"ログインに失敗しました"}));
          errorBox.textContent = err.detail || "ログインに失敗しました";
          return;
        }

        const json = await res.json();
        localStorage.setItem("access", json.access);
        localStorage.setItem("refresh", json.refresh);

        const me = await fetch("/api/me/", {
          headers: { Authorization: "Bearer " + json.access },
        });

        if (me.ok) {
          window.location.href = "/apply/"; 
        } else {
          errorBox.textContent = "ログインしましたが、ユーザー情報を読み込めませんでした。";
        }
      } catch (e) {
        errorBox.textContent = "ネットワークエラー";
      }
    });
  </script>
</body>
</html>
